
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html xmlns:wb="http://open.weibo.com/wb" class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>teohm.dev</title>
  <meta name="author" content="Huiming Teo (teohm)">

  
  <meta name="description" content="Have you ever setup a Rails production environment from scratch, by
hand? If you had, I share your pain every time when a new project
started. The &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="related_content_manifest" value="a22f91cd-07f6-4154-8c8c-b7033b28a633"/>

  
  <link rel="canonical" href="http://teohm.github.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/teohm" rel="alternate" title="teohm.dev" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

 


<meta property="og:description" content="Have you ever setup a Rails production environment from scratch, by
hand? If you had, I share your pain every time when a new project
started. The process is often repetitive. To me, it seems to be a waste to do it
manually every time. It also consumes time and attention. It would be
great if I &hellip;">


<script type='text/javascript'>//<![CDATA[
(function() {
  var script = document.createElement('script');
  script.type  = 'text/javascript';
  script.async = 'async';
  script.src   = 'https://choruswp.nik.io/v1/related_content.js?id=392033&api_key=fd9c6833f5f710740979381b40240de9292abeeddd4e741';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(script, s);
})();//]]>
</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-28076807-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">teohm.dev</a></h1>
  
    <h2>I enjoy life, and make stuff for people I care about :)</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/teohm" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:teohm.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/17/chef-cookbooks-for-busy-ruby-developers/">Chef Cookbooks for Busy Ruby Developers</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-17T23:06:00+08:00" pubdate data-updated="true">Apr 17<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Have you ever <strong>setup a Rails production environment from scratch, by
hand</strong>? If you had, I share your pain every time when a new project
started.</p>

<p>The process is often repetitive. To me, it seems to be a waste to do it
manually every time. It also consumes time and attention. It would be
great if I could spend them on tasks that bring more values to clients.</p>

<p>To minimize such waste, I have written two Chef cookbooks to <strong>automate
the process</strong>:</p>

<ul>
<li><a href="https://github.com/teohm/rackbox-cookbook"><strong>rackbox</strong></a>  - to provision <strong>rack-based web server</strong> (Nginx as front server, Unicorn and Passenger as upstream app servers, <code>rbenv</code> as ruby version manager).</li>
<li><a href="https://github.com/teohm/databox-cookbook"><strong>databox</strong></a> - to provision <strong>database server</strong> (supports MySQL and PostgreSQL).</li>
</ul>


<h2>Getting started</h2>

<p>In this post, I will show you a <strong>step-by-step guide</strong> on how to use the
cookbooks together with
<a href="https://github.com/matschaffer/knife-solo"><code>knife-solo</code></a> to provision a
remote server in 4 steps:</p>

<ol>
<li>setup Chef Solo environment</li>
<li>modify config file</li>
<li>provision remote server</li>
<li>tweak Capistrano <code>deploy.rb</code></li>
</ol>


<p>A working example in also available at
<a href="https://github.com/teohm/kitchen-example">teohm/kitchen-example</a>.</p>

<h2>1. Setup Chef Solo environment</h2>

<ul>
<li>Install Chef Solo tools on local machine.</li>
<li>Download Chef cookbooks to local machine.</li>
<li>Install <code>chef-solo</code> on remote server.</li>
</ul>


<h3>Install Chef Solo tools</h3>

<p>Let&#8217;s create a new directory,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir chef-kitchen
</span><span class='line'>cd chef-kitchen</span></code></pre></td></tr></table></div></figure>


<p>and a <code>Gemfile</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>source "https://rubygems.org"
</span><span class='line'>
</span><span class='line'>gem "knife-solo", "&gt;= 0.3.0pre3"
</span><span class='line'>gem "berkshelf"</span></code></pre></td></tr></table></div></figure>


<p>I recommend <code>knife-solo &gt;= 0.3</code> as it includes a few <a href="https://github.com/matschaffer/knife-solo/blob/master/CHANGELOG.md#changes-and-new-features">major fixes and
improvements</a>.</p>

<p>Now, install the ruby gems.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle install</span></code></pre></td></tr></table></div></figure>


<p>Finally, setup a kitchen directory structure with <code>knife-solo</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle exec knife solo init .</span></code></pre></td></tr></table></div></figure>


<h3>Download Chef cookbooks</h3>

<p>I use <a href="http://berkshelf.com/">Berkshelf</a> to manage cookbooks. So we need a <code>Berksfile</code>,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>site :opscode
</span><span class='line'>
</span><span class='line'>cookbook "runit", "&gt;= 1.1.2"  # HACK: force-use this version
</span><span class='line'>cookbook "databox"
</span><span class='line'>cookbook "rackbox"</span></code></pre></td></tr></table></div></figure>


<p>(I added a hack here to force <code>berkshelf</code> to use <code>runit 1.1.2</code> required
by <code>rackbox</code>. Still looking for a better solution.)</p>

<p>We can now download cookbooks with <code>berks install</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle exec berks install --path cookbooks/</span></code></pre></td></tr></table></div></figure>


<h3>Install <code>chef-solo</code> on remote server</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle exec knife solo prepare testbox</span></code></pre></td></tr></table></div></figure>


<p>In this example, <code>testbox</code> is a host I setup in my <code>~/.ssh/config</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Host testbox
</span><span class='line'>  User ubuntu
</span><span class='line'>  Hostname ec2-51-221-13-121.ap-southeast-1.compute.amazonaws.com
</span><span class='line'>  IdentityFile ~/.ssh/testbox_ec2.pem</span></code></pre></td></tr></table></div></figure>


<h2>2. Customize config file</h2>

<ul>
<li>Download config example</li>
<li>Customize config file</li>
</ul>


<h3>Download config example</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl https://raw.github.com/teohm/kitchen-example/master/nodes/host.json.example --output nodes/testbox.json</span></code></pre></td></tr></table></div></figure>


<h3>Modify config file (JSON)</h3>

<p>The config file starts with a <code>run_list</code>. You specify a list of cookbook
recipes here. Chef will run them in the same order in this list.</p>

<p>It is followed by cookbook attributes. You can modify these attributes.
A full reference of attributes are described in each cookbook&#8217;s README
(see <a href="https://github.com/teohm/appbox-cookbook#attributes">appbox</a>,
<a href="https://github.com/teohm/databox-cookbook#attributes">databox</a>,
<a href="https://github.com/teohm/rackbox-cookbook#attributes">rackbox</a>).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "run_list": [
</span><span class='line'>    "databox",
</span><span class='line'>    "rackbox"
</span><span class='line'>  ],
</span><span class='line'>  "appbox": {
</span><span class='line'>    "deploy_keys": ["ssh-rsa 5bnmu23890fghghjk"],
</span><span class='line'>    "admin_keys": ["ssh-rsa 456789fghjkvbn567"]
</span><span class='line'>  },
</span><span class='line'>  "databox": {
</span><span class='line'>    "db_root_password": "welcome!",
</span><span class='line'>    "databases": {
</span><span class='line'>      "mysql": [
</span><span class='line'>        { "username": "app1",
</span><span class='line'>          "password": "app1",
</span><span class='line'>          "database_name": "app1_production" }
</span><span class='line'>      ],
</span><span class='line'>      "postgresql": [
</span><span class='line'>        { "username": "app2",
</span><span class='line'>          "password": "app2",
</span><span class='line'>          "database_name": "app2_production" }
</span><span class='line'>      ]
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  "rackbox": {
</span><span class='line'>    "ruby": {
</span><span class='line'>      "versions": ["1.9.3-p385", "1.9.2-p320"],
</span><span class='line'>      "global_version": "1.9.3-p385"
</span><span class='line'>    },
</span><span class='line'>    "apps": {
</span><span class='line'>      "unicorn": [
</span><span class='line'>        { "appname": "app1",
</span><span class='line'>          "hostname": "app1.test.com" }
</span><span class='line'>      ],
</span><span class='line'>      "passenger": [
</span><span class='line'>        { "appname": "app2",
</span><span class='line'>          "hostname": "app2.test.com" }
</span><span class='line'>      ]
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h2>3. Provision remote server</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle exec knife solo cook testbox</span></code></pre></td></tr></table></div></figure>


<p>It uploads the kitchen directory and runs <code>chef-solo</code> on the remote
server. Chef-solo will then takeover and execute the run list to setup
everything.</p>

<h3>What do we get at this point?</h3>

<p>Basically, it&#8217;s done!</p>

<p>We have a <strong>full-stack, rack-based server</strong> with:</p>

<ul>
<li>3 user accounts (deploy, devops, apps)</li>
<li><code>rbenv</code> as ruby version manager</li>
<li><code>nginx</code> as front-server</li>
<li><code>unicorn</code>, <code>passenger-standalone</code> as upstream app servers, managed by <code>runit</code></li>
<li><code>postgresql</code>, <code>mysql</code> installed and databases created</li>
<li>all apps will be stored in <code>/home/apps/</code></li>
</ul>


<h2>4. Tweak Capistrano deploy.rb</h2>

<p>Now, it&#8217;s ready to deploy a Rack-based app to the remote server!</p>

<p>I have two example Rails apps available on Github:</p>

<ul>
<li><a href="https://github.com/teohm/sample-app1">teohm/sample-app1</a> runs on unicorn,</li>
<li><a href="https://github.com/teohm/sample-app2">teohm/sample-app2</a> runs on passenger-standalone.</li>
</ul>


<p>There are a few <strong>minor tweaks required in Capistrano <code>deploy.rb</code></strong>, as listed below.</p>

<p>I will explain the tweaks in details next time. Meanwhile, check out the complete working examples at: <a href="https://github.com/teohm/sample-app1/blob/master/config/deploy.rb">app1/config/deploy.rb</a> and <a href="https://github.com/teohm/sample-app2/blob/master/config/deploy.rb">app2/config/deploy.rb</a></p>

<h3>Login as <code>deploy</code> user</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>set :user, "deploy"</span></code></pre></td></tr></table></div></figure>


<h3>Deploy to <code>/home/apps</code></h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>set :deploy_to, "/home/apps/#{application}"</span></code></pre></td></tr></table></div></figure>


<h3>Load <code>rbenv</code> in Capistrano</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>default_run_options[:shell] = '/bin/bash --login'</span></code></pre></td></tr></table></div></figure>


<h3>Run bundler with <code>--binstubs</code></h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>require 'bundler/capistrano'
</span><span class='line'>set :bundle_flags, "--deployment --binstubs"
</span><span class='line'>set :bundle_without, [:test, :development, :deploy]</span></code></pre></td></tr></table></div></figure>


<h3>Restart app with <code>runit sv</code></h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>namespace :deploy do
</span><span class='line'>  task :start do
</span><span class='line'>    run "sudo sv up app1"
</span><span class='line'>  end
</span><span class='line'>  task :stop do
</span><span class='line'>    run "sudo sv down app1"
</span><span class='line'>  end
</span><span class='line'>  task :restart, :roles =&gt; :app, :except =&gt; { :no_release =&gt; true } do
</span><span class='line'>    run "sudo sv restart app1"
</span><span class='line'>  end
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<h2>Feedback</h2>

<p>If you are interested on using the cookbooks, or have an idea/feedback/question about this topic, feel free to drop me (<a href="http://twitter.com/teohm">@teohm</a>) a message. Pull requests and issue reports are definitely welcomed!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/10/reload-required-files-in-rails/">Reload Required Files in Rails</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-10T12:34:00+08:00" pubdate data-updated="true">Jan 10<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When a Rails project grows, I often notice the need to <strong>refactor domain logic into a separate module, isolated from Rails framework</strong>.</p>

<p>The isolated module will still stay in the main Rails app codebase, but can be easily packaged as a Ruby gem, tested separately, and used in other related applications.</p>

<h2>Requirements</h2>

<p>During the refactoring, we want to:</p>

<ol>
<li><p><strong>Use <code>require</code> to load the module like a normal gem</strong>. If possible, no dependency on Rails autoload features such as<code>require_dependency</code> and <code>autoload_paths</code>.</p></li>
<li><p><strong>Edit the module without restarting server during development</strong>. In other words, we need to find a way to <strong>reload the module on every request</strong>.</p></li>
</ol>


<h2>Reload <code>require</code> files</h2>

<p>After some research, I found a <a href="http://timcardenas.com/automatically-reload-gems-in-rails-327-on-eve"><strong>working solution</strong></a> by Timothy Cardenas:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ActionDispatch::Callbacks.to_prepare do
</span><span class='line'>  if Object.const_defined?("Module1")
</span><span class='line'>    Object.send(:remove_const, "Module1")
</span><span class='line'>  end
</span><span class='line'>  $".delete_if {|s| s.include?('module1') }
</span><span class='line'>  require 'module1'
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>What it does is, before each request,</p>

<ol>
<li>Unload the top-level module.</li>
<li>Un-require all required files from the module.</li>
<li>Re-require the top-level module.</li>
</ol>


<h2>An extra step in Rails 3.2</h2>

<p>In Rails 3.2, <code>ActionDispatch::Callbacks.to_prepare</code> has a slightly different behavior. It will run before a request <strong>only if a watchable file is modified</strong>.</p>

<p>You need to specify your own <a href="http://api.rubyonrails.org/classes/Rails/Railtie/Configuration.html#method-i-watchable_dirs">watchable files</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># watch all .rb files recursively under modules/module1/ dir
</span><span class='line'>config.watchable_dirs['modules/module1'] = [:rb]</span></code></pre></td></tr></table></div></figure>


<h2>Introduce <code>require_reloader</code> gem</h2>

<p>Before bundling the solution into a gem, I did a search on RubyGems.org and found Colin Young&#8217;s <a href="https://github.com/colinyoung/gem_reloader">gem_reloader</a>. It&#8217;s based on Timy&#8217;s solution as well. I forked it and started playing around.</p>

<p>In the end, I made some major changes to include Rails 3.2 support, some fixes and new features.</p>

<p>So I decided to <strong>release it as a new Ruby gem: <a href="https://github.com/teohm/require_reloader">require_reloader</a></strong>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># config/environments/development.rb
</span><span class='line'>YourApp::Application.configure do
</span><span class='line'>  ...
</span><span class='line'>  RequireReloader.watch :module1,
</span><span class='line'>    path: 'modules/module1'
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Currently it supports Rails 3, including 3.1 and 3.2.</p>

<p>If you are working on something similar, looking forward for your feedbacks and pull requests. It is not tested on Rails 2 yet, so pull requests are definitely welcomed!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/15/start-using-ruby-percent-notation/">Start Using Ruby % (Percent) Notation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-15T18:04:00+08:00" pubdate data-updated="true">Oct 15<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you seldom use Ruby percent (%) notation in daily work, here&#8217;s a
<strong>quick summary</strong> of what I picked up recently.</p>

<h2>Delimiter allows any non-alphanum</h2>

<p>You can use any <strong>non alpha-numeric character</strong> as delimiter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">%(any alpha-numeric)</span>
</span><span class='line'><span class="sx">%[char can be]</span>
</span><span class='line'><span class="sx">%%used as%</span>
</span><span class='line'><span class="sx">%!delimiter\!!</span> <span class="c1"># escape &#39;!&#39; literal</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Bracket pairs no need to escape</h2>

<p><strong>No need to escape bracket pairs</strong>, even when <strong>nested</strong>.
You can escape, but will need to escape both open and close bracket.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">%( (pa(re(nt)he)sis) )</span> <span class="c1">#=&gt; &quot;(pa(re(nt)he)sis)&quot;</span>
</span><span class='line'><span class="sx">%[ [square bracket] ]</span>  <span class="c1">#=&gt; &quot;[square bracket]&quot;</span>
</span><span class='line'><span class="sx">%{ {curly bracket} }</span>   <span class="c1">#=&gt; &quot;{curly bracket}&quot;</span>
</span><span class='line'><span class="sx">%&lt; &lt;pointy bracket&gt; &gt;</span>  <span class="c1">#=&gt; &quot;&lt;pointy bracket&gt;&quot;</span>
</span><span class='line'><span class="sx">%&lt; \&lt;this works as well\&gt; &gt;</span>  <span class="c1">#=&gt; &quot;&lt;this works as well&gt;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Modifiers for String, Regex, Array, Symbol, Shell command</h2>

<p>We often use % notation to <strong>create String and Array</strong> literals. But it
also supports <strong>Symbol, Regex and shell command</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">%(interpolated string (</span><span class="si">#{</span> <span class="s2">&quot;default&quot;</span> <span class="si">}</span><span class="sx">))</span>
</span><span class='line'>  <span class="c1">#=&gt; &quot;interpolated string (default)&quot;</span>
</span><span class='line'><span class="sx">%Q(interpolated string (</span><span class="si">#{</span> <span class="s2">&quot;default&quot;</span> <span class="si">}</span><span class="sx">))</span>
</span><span class='line'>  <span class="c1">#=&gt; &quot;interpolated string (default)&quot;</span>
</span><span class='line'><span class="sx">%q(non-interpolated string)</span>
</span><span class='line'>  <span class="c1">#=&gt; &quot;non-interpolated string&quot;</span>
</span><span class='line'><span class="sr">%r(</span><span class="si">#{</span> <span class="s2">&quot;interpolated&quot;</span> <span class="si">}</span><span class="sr"> regexp)i</span>
</span><span class='line'>  <span class="c1">#=&gt; /interpolated regexp/i</span>
</span><span class='line'><span class="sx">%w(non-interpolated\ string  separated\ by\ whitespaces)</span>
</span><span class='line'>  <span class="c1">#=&gt; [&#39;non-interpolated string&#39;, &#39;separated by whitespaces&#39;]</span>
</span><span class='line'><span class="sx">%W(interpolated\ string </span><span class="si">#{</span> <span class="s2">&quot;separated by whitespaces&quot;</span> <span class="si">}</span><span class="sx">)</span>
</span><span class='line'>  <span class="c1">#=&gt; [&#39;interpolated string&#39;, &#39;separated by whitespaces&#39;]</span>
</span><span class='line'><span class="sx">%s(non-interpolated symbol)</span>
</span><span class='line'>  <span class="c1">#=&gt; :&#39;non-interpolated symbol&#39;</span>
</span><span class='line'><span class="sx">%x(echo </span><span class="si">#{</span> <span class="s2">&quot;interpolated shell command&quot;</span> <span class="si">}</span><span class="sx">)</span>
</span><span class='line'>  <span class="c1">#=&gt; &quot;interpolated shell command\n&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&#8217;s some <a href="https://github.com/teohm/a-dip-in-ruby/blob/master/spec/percent_notation_spec.rb">% notation examples written in minitest</a> in case you interested.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/10/02/ruby-idiom-to-ensure-variable-is-array/">Ruby Idiom to Ensure Variable Is Array</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-02T23:27:00+08:00" pubdate data-updated="true">Oct 2<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Stop</strong> doing this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">arry</span> <span class="o">=</span> <span class="n">input</span> <span class="o">||</span> <span class="o">[]</span>  <span class="c1"># handle input == nil</span>
</span><span class='line'><span class="n">arry</span> <span class="o">=</span> <span class="o">[</span><span class="n">input</span><span class="o">]</span> <span class="k">unless</span> <span class="n">arry</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="nb">Array</span><span class="p">)</span>  <span class="c1"># handle single value object</span>
</span><span class='line'>
</span><span class='line'><span class="n">arry</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'>  <span class="c1">#process item</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Ruby, you should use
<a href="http://www.ruby-doc.org/core-1.9.3/Kernel.html#method-i-Array">Kernel#Array</a>
to <strong>convert the variable into an array object</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">Array</span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># process item</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Array(nil)     # =&gt; []</span>
</span><span class='line'><span class="c1"># Array(&quot;foo&quot;)   # =&gt; [&quot;foo&quot;]</span>
</span><span class='line'><span class="c1"># Array([1,2,3]) # =&gt; [1,2,3]</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/teohm/a-dip-in-ruby/blob/master/spec/kernel_array_spec.rb">More usage examples</a> written in minitest.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/24/objective-c-collection-operators/">Objective-C Collection Operators</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-24T13:52:00+08:00" pubdate data-updated="true">Sep 24<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Calculate average - a shorter way</h2>

<p>When you have a collection of <code>Transactions</code> objects and want to
calculate its average amount, instead of looping through the collection
like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">Transaction</span> <span class="o">*</span><span class="n">transaction</span> <span class="k">in</span> <span class="n">transactions</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">sum</span> <span class="o">+=</span> <span class="p">[</span><span class="n">transaction</span><span class="p">.</span><span class="n">amount</span> <span class="n">doubleValue</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="n">avg</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSNumber</span> <span class="nl">numberWithDouble:</span><span class="p">(</span><span class="n">sum</span> <span class="o">/</span> <span class="p">[</span><span class="n">transactions</span> <span class="n">count</span><span class="p">])];</span>
</span></code></pre></td></tr></table></div></figure>


<p>you can <strong>reduce the loop to 1 line of code</strong>, using
<a href="http://developer.apple.com/library/mac/#documentation/cocoa/Conceptual/KeyValueCoding/Articles/CollectionOperators.html">Objective-C key-value coding</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="n">avg</span> <span class="o">=</span> <span class="p">[</span><span class="n">transactions</span> <span class="nl">valueForKeyPath:</span><span class="s">@&quot;@avg.amount&quot;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Currently, there is a <strong>fixed set</strong> of collection operators:</p>

<ul>
<li>Simple collection operators (<code>@avg</code>, <code>@count</code>, <code>@sum</code>, <code>@max</code>, <code>@min</code>)</li>
<li>Object operators (<code>@distinctUnionOfObjects</code>, <code>@unionOfObjects</code>)</li>
<li>Array and set operators (<code>@distinctUnionOfArrays</code>, <code>@unionOfArrays</code>)</li>
</ul>


<p>For details, refer to more
<a href="http://developer.apple.com/library/mac/#documentation/cocoa/Conceptual/KeyValueCoding/Articles/CollectionOperators.html">usage</a> <a href="https://github.com/teohm/a-dip-in-objective-c/blob/master/ADipInObjectiveCTests/CollectionOperatorTests.m">examples</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/09/03/breaking-arc-retain-cycle-in-objective-c-blocks/">Breaking ARC Retain Cycle in Objective-C Blocks</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-03T17:50:00+08:00" pubdate data-updated="true">Sep 3<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In a recent client project, we noticed its iOS app often <strong>received low memory
warning</strong>. The iOS app is developed with ARC-enabled (Automatic Reference Counting).</p>

<p>When profiled the app using <strong>Instruments > Allocations</strong>, we found that
a lot of unused ViewController objects were not released from memory.</p>

<h2>Retain Cycle</h2>

<p>The codebase uses a lot of <strong>Objective-C blocks</strong> as shown below, and
<code>self</code> is often being called within the blocks:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">@interface</span> <span class="nc">DetailPageViewController</span> : <span class="nc">UIViewController</span>
</span><span class='line'><span class="k">@property</span><span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UIButton</span> <span class="o">*</span><span class="n">backButton</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="n">implementation</span> <span class="n">DetailPageViewController</span>
</span><span class='line'><span class="k">@synthesize</span> <span class="n">backButton</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">loadView</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">doneButton</span> <span class="nl">onTouch:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">sender</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span> <span class="n">doSomething</span><span class="p">];</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">isDone</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example code, the controller object holds a <strong>strong reference to
<code>doneButton</code> object</strong>. But because <code>doneButton onTouch:</code> block is calling
<code>self</code>, now the button object <strong>holds a strong reference back to the controller
object</strong>.</p>

<p>When object A points strongly to object B, and B points strongly to A, a
<a href="http://cocoawithlove.com/2009/07/rules-to-avoid-retain-cycles.html"><strong>retain cycle</strong></a> is created,
and both objects cannot be released from memory.</p>

<h2>Use Lifetime Qualifiers</h2>

<p><a href="http://developer.apple.com/library/mac/#releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html#//apple_ref/doc/uid/TP40011226-CH1-SW9">Apple Developer&#8217;s guide on ARC transition</a> suggested a few ways to <strong>break the retain cycle using different lifetime
qualifiers</strong>. It is definitely a <strong>must read</strong> for iOS development.</p>

<p>If your app is targeted for iOS 5, you can use <code>__weak</code> lifetime qualifier to break the cycle:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">@interface</span> <span class="nc">DetailPageViewController</span> : <span class="nc">UIViewController</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">loadView</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="n">__weak</span> <span class="n">DetailPageViewController</span> <span class="o">*</span><span class="n">controller</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'>  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">doneButton</span> <span class="nl">onTouch:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">sender</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">controller</span> <span class="n">doSomething</span><span class="p">];</span>
</span><span class='line'>    <span class="n">controller</span><span class="p">.</span><span class="n">isDone</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because we are using <code>__weak</code> qualifier, <code>doneButton onTouch:</code> block
only has <strong>a weak reference to the controller object</strong>. Now, the controller
object can be released from memory when its reference count drops to 0.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/08/mac-tips-use-caps-lock-as-control-key/">Mac Tips: Use Caps Lock as Control Key</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-08T10:20:00+08:00" pubdate data-updated="true">Apr 8<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>After using <a href="http://tmux.sourceforge.net/">tmux</a>, I start using Control
key a lot often. I decided to move my Control key up to the home row,
by assigning it to <strong>Caps Lock</strong>.</p>

<p>For Mac users, open <strong>System Preferences > Keyboard</strong>, choose <strong>Keyboard</strong> tab.
Click button <strong>Modifier Keys..</strong> and change <strong>Caps Lock Key:</strong> to <strong>^ Control</strong>.</p>

<p><img src="/images/mac-tips/caps-lock-as-control-key.png" title="A screenshot of Key Modifier Keys dialog" alt="A screenshot of Key Modifier Key dialog"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/07/mac-tips-change-default-application-for-a-file-type/">Mac Tips: Change Default Application for a File Type</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-07T18:46:00+08:00" pubdate data-updated="true">Apr 7<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>To switch the default application for file type,
right-click the file, select <strong>Get Info</strong> and change the application in
<strong>Open With</strong> section.</p>

<p>Remember, remember.. click <strong>Change All&#8230;</strong> button to <strong>apply the changes to <em>all</em>
files</strong>. It seems obvious, but took me a while to figure this out. :)</p>

<p><img src="/images/mac-tips/default-application-for-file-type.png" title="A screenshot of Get Info dialog" alt="A screenshot of Get Info dialog"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/07/mac-tips-turn-on-remote-login-ssh-server/">Mac Tips: Turn on Remote Login (SSH Server)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-07T15:12:00+08:00" pubdate data-updated="true">Apr 7<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Enable SSH server on Mac OSX is surprisingly easy. Open <strong>System Preferences >
Sharing</strong>, and turn on <strong>Remote Login</strong>. You can futher restrict which user can
login via SSH on the same screen.</p>

<p><img src="/images/mac-tips/remote-login.png" title="A screenshot Sharing dialog box." alt="A screenshot Sharing dialog box."></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/01/using-sshuttle-in-daily-work/">Using Sshuttle in Daily Work</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-01T13:13:00+08:00" pubdate data-updated="true">Apr 1<span>st</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was first introduced to <a href="https://github.com/apenwarr/sshuttle"><strong>sshuttle</strong></a> by Sooyoung (<a href="https://twitter.com/#!/5ooyoung">@5ooyoung</a>) in <a href="http://favoritemedium.com/">Favorite Medium</a>
as a workaround to The Great Firewall in China.</p>

<p>Since then, it has become my <strong>light-weight network tunneling tool</strong> in daily work.</p>

<h2>Install sshuttle</h2>

<p>The installation is easy now. You can install it through Mac OSX Homebrew, or <a href="http://packages.ubuntu.com/precise/sshuttle">Ubuntu apt-get</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install sshuttle
</span></code></pre></td></tr></table></div></figure>


<h2>I use sshuttle to..</h2>

<h3>1. Tunnel all traffic</h3>

<p>This is the first command I learned.
It <strong>forwards all TCP traffic and DNS requests to a remote SSH server</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sshuttle --dns -vr ssh_server 0/0
</span></code></pre></td></tr></table></div></figure>


<p>Just like <code>ssh</code>, you can use any server specified in <code>~/.ssh/config</code>.
The <code>-v</code> flag means verbose mode.</p>

<p>Besides TCP and DNS, currently <code>sshuttle</code> <strong>does not forward other requests
<em>such as</em> UDP, ICMP ping etc</strong>.</p>

<h3>2. Tunnel all traffic, but exclude some</h3>

<p>You can <strong>exclude certain TCP traffic using <code>-x</code> option</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sshuttle --dns -vr ssh_server -x 121.9.204.0/24 -x 61.135.196.21 0/0
</span></code></pre></td></tr></table></div></figure>


<p>For instance, when I am in China, I don&#8217;t want to tunnel
<a href="http://youku.com">Youku.com</a> traffic to a foreign server,
because its movie streaming service is only available within China.</p>

<p>In this case, I use <code>-x</code> option to exclude Youku.com IP addresses.</p>

<h3>3. Tunnel only certain traffic</h3>

<p>To tunnel only certain TCP traffic, <strong>specify the IP addresses
or <a href="http://www.subnet-calculator.com/cidr.php">IP ranges</a> that need tunneling</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sshuttle -vr ssh_server 121.9.204.0/24 61.135.196.21
</span></code></pre></td></tr></table></div></figure>


<p>This command comes in handy, whenever I need to test an app feature (e.g. Netflix movie streaming)
which only available in certain countries, or to bypass ISP faulty caches.</p>

<h3>4. VPN to office network</h3>

<p>I seldom do VPN, but all you need is <strong>the remote SSH server with <code>-NH</code> flags turned on</strong>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sshuttle -NHvr office_ssh_server
</span></code></pre></td></tr></table></div></figure>


<p><code>-N</code> flag tells sshuttle to figure out by itself the IP subnets to forward,
and <code>-H</code> flag to scan for hostnames within remote subnets and store them temporarily in <code>/etc/hosts</code>.</p>

<h2>IP addresses.. troublesome?</h2>

<p>Well, I try not to deal with IP addresses manually. So I wrote a few
<strong><a href="https://github.com/teohm/dotfiles/blob/master/.bashrc.d/sshuttle_helpers">sshuttle helpers</a>
(<code>tnl</code>, <code>tnlbut</code>, <code>tnlonly</code>, <code>vpnto</code>)</strong> that allow me to <strong>use domain names instead of IP addresses</strong>:</p>

<h3>Tunnel all traffic</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tnl
</span></code></pre></td></tr></table></div></figure>


<h3>Tunnel all traffic, but exclude some</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tnlbut youku.com weibo.com
</span></code></pre></td></tr></table></div></figure>


<h3>Tunnel only certain traffic</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tnlonly netflix.com movies.netflix.com
</span></code></pre></td></tr></table></div></figure>


<h3>VPN to office network</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vpnto office_ssh_server
</span></code></pre></td></tr></table></div></figure>


<p>The script is available on <a href="https://github.com/teohm/dotfiles/blob/master/.bashrc.d/sshuttle_helpers">my GitHub repo</a>.
You can load it into your <code>~/.bashrc</code>. <strong>To override the default tunneling SSH server</strong> in the script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">TNL_SERVER</span><span class="o">=</span>user@another_server tnl
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>My Tools</h1>
  <ul id="tools">
      <li class="post">
        <a href="/revoke-access/">Revoke any authorized access</a>
      </li>
  </ul>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/04/17/chef-cookbooks-for-busy-ruby-developers/">Chef cookbooks for busy Ruby developers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/10/reload-required-files-in-rails/">Reload required files in Rails</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/15/start-using-ruby-percent-notation/">Start Using Ruby % (Percent) Notation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/02/ruby-idiom-to-ensure-variable-is-array/">Ruby idiom to ensure variable is Array</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/24/objective-c-collection-operators/">Objective-C Collection Operators</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("teohm", 3, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/teohm" class="twitter-follow-button" data-show-count="false">Follow @teohm</a>
  
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/toydi?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/toydi">My Delicious Bookmarks &raquo;</a></p>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/100712640845389576742?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Huiming Teo (teohm) -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'teohm';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script type="text/javascript">
    var infolinks_pid = 1125985;
        var infolinks_wsid = 0;
</script>
<script type="text/javascript" src="http://resources.infolinks.com/js/infolinks_main.js"></script>
<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js?appkey=" type="text/javascript" charset="utf-8"></script>


</body>
</html>
